# using staged builds
FROM node:alpine AS builder
# make the directory where the project files will be stored
# set it as the working directory so that we don't need to keep referencing it
WORKDIR /app
# Copy package.json and package-lock.json/yarn.lock from the 'backend' directory
# The source path 'backend/package.json' is relative to the build context (project root)
COPY backend/package*.json ./
# Use package-lock.json if you use npm, or yarn.lock if you use yarn
# install project dependencies
RUN npm install
# copy project files 
COPY backend/. .
#Run NPM
RUN npm run build

# Use a lightweight Node.js base image for running the Next.js app
FROM node:alpine AS production

WORKDIR /app

# Copy built application from the builder stage
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/package.json ./package.json
# Copy public assets
COPY --from=builder /app/public ./public 

# Expose port 5000 (Next.js default) internally
EXPOSE 5000

CMD ["npm", "run", "dev"]

